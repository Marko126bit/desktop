name: 3klika Nextcloud Windows (Qt from vcpkg)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Ninja
        shell: powershell
        run: choco install ninja -y

      - name: Install pkg-config
        shell: powershell
        run: choco install pkgconfiglite -y

      #################################################
      # FAKE libp11
      #################################################
      - name: Create fake libp11
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "C:\fake-libp11\lib\pkgconfig" | Out-Null
          Set-Content -Path "C:\fake-libp11\lib\pkgconfig\libp11.pc" -Value @"
          prefix=C:/fake-libp11
          exec_prefix=${prefix}
          libdir=${prefix}/lib
          includedir=${prefix}/include
          Name: libp11
          Description: Fake libp11 for Windows
          Version: 1.0
          Libs:
          Cflags:
          "@

      - name: Add fake libp11 to PKG_CONFIG_PATH
        shell: powershell
        run: |
          echo "PKG_CONFIG_PATH=C:\fake-libp11\lib\pkgconfig" | Out-File -FilePath $env:GITHUB_ENV -Append

      #################################################
      # VCPKG â€“ Qt6 + zavisnosti
      #################################################
      - name: Setup vcpkg and install dependencies
        shell: powershell
        run: |
          if (!(Test-Path "C:\vcpkg")) {
            git clone https://github.com/microsoft/vcpkg C:\vcpkg
          }

          C:\vcpkg\bootstrap-vcpkg.bat

          $triplet = "x64-windows"

          C:\vcpkg\vcpkg.exe install `
            openssl:$triplet `
            zlib:$triplet `
            sqlite3:$triplet `
            ecm:$triplet `
            qtbase:$triplet `
            qtdeclarative:$triplet `
            qttools:$triplet `
            qtsvg:$triplet `
            qtwebsockets:$triplet `
            qtwebchannel:$triplet `
            qtwebengine:$triplet `
            qt5compat:$triplet `
            qtquickcontrols2:$triplet `
            qtquickwidgets:$triplet `
            qtnetworkauth:$triplet `
            kf6-archive:$triplet `
            kf6-guiaddons:$triplet `
            cmocka:$triplet `
            qtkeychain-qt6:$triplet

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      #################################################
      # CONFIGURE CMAKE
      #################################################
      - name: Configure (CMake)
        shell: cmd
        run: |
          mkdir build
          cd build
          cmake -G "Ninja" ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_DISABLE_FIND_PACKAGE_libp11=ON ^
            -DBUILD_UPDATER=OFF ^
            -DWITH_CRASHREPORTER=OFF ^
            -DBUILD_SHELL_INTEGRATION=OFF ^
            -DCMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake ^
            -DVCPKG_TARGET_TRIPLET=x64-windows ^
            -DCMAKE_PREFIX_PATH="C:\vcpkg\installed\x64-windows" ^
            -DQt6_DIR="C:\vcpkg\installed\x64-windows\share\qt6" ^
            ..

      - name: Build
        shell: cmd
        run: |
          cd build
          cmake --build . --config Release

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nextcloud-3klika-qt-vcpkg
          path: build/**/*.exe

